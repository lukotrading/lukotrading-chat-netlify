<div id="luko-chatbot" style="max-width: 520px; min-width: 320px; height: 680px; border: 2px solid #004aad; border-radius: 12px; display: flex; flex-direction: column; font-family: Arial, sans-serif; overflow: hidden; box-shadow: 0 0 12px rgba(0,0,0,0.15); margin: 20px auto;">
  <div style="background-color: #004aad; color: white; padding: 14px; font-size: 18px; font-weight: bold; text-align: center;">
    Vraag het aan de Expert
  </div>
  <div id="chat-window" style="flex: 1; padding: 12px; overflow-y: auto; background-color: #f9f9f9;"></div>
  <div style="display: flex; border-top: 1px solid #ccc;">
    <input id="chat-input" type="text" placeholder="Stel je vraag over Innolab…" style="flex: 1; padding: 12px; border: none; outline: none; font-size: 15px;">
    <button id="chat-send" style="background-color: #004aad; color: white; border: none; padding: 0 18px; cursor: pointer; font-size: 14px;">Stuur</button>
  </div>
</div>

<script>
  const BACKEND = "https://frabjous-sawine-93562c.netlify.app/.netlify/functions/chat";
  const chatWindow = document.getElementById("chat-window");
  const chatInput = document.getElementById("chat-input");
  const chatSend = document.getElementById("chat-send");

  function addMessage(sender, text, isError=false) {
    const msg = document.createElement("div");
    msg.style.marginBottom = "10px";
    msg.style.whiteSpace = "pre-wrap";
    msg.innerHTML = `<strong>${sender}:</strong> ${text}`;
    if (isError) msg.style.color = "#b00020";
    chatWindow.appendChild(msg);
    chatWindow.scrollTop = chatWindow.scrollHeight;
  }

  function setTyping(show) {
    let t = document.getElementById("typing");
    if (show) {
      if (!t) {
        t = document.createElement("div");
        t.id = "typing";
        t.style.opacity = "0.7";
        t.innerHTML = "<em>Lukotrading typt…</em>";
        chatWindow.appendChild(t);
      }
    } else if (t) {
      t.remove();
    }
    chatWindow.scrollTop = chatWindow.scrollHeight;
  }

  async function sendMessage() {
    const question = chatInput.value.trim();
    if (!question) return;
    addMessage("U", question);
    chatInput.value = "";
    setTyping(true);

    try {
      const resp = await fetch(BACKEND, {
        method: "POST",
        mode: "cors",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ messages: [{ role: "user", content: question }] })
      });
      const text = await resp.text();
      setTyping(false);

      if (!resp.ok) {
        addMessage("Lukotrading", `Fout (${resp.status}): ${text || "Onbekende serverfout"}`, true);
        return;
      }
      addMessage("Lukotrading", text || "(leeg antwoord)");
    } catch (err) {
      setTyping(false);
      addMessage("Lukotrading", "Netwerkfout: " + (err && err.message ? err.message : err), true);
      console.error(err);
    }
  }

  chatSend.addEventListener("click", sendMessage);
  chatInput.addEventListener("keypress", e => {
    if (e.key === "Enter") sendMessage();
  });

  // Welkomstbericht
  addMessage("Lukotrading", "Welkom! Stel je vraag over Innolab-producten (bv. mos/algen op dak of terras, kalk in douche, airco reinigen).");
</script>
